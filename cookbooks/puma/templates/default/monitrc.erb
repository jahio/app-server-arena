#
# Generated by chef; your changes will be overwritten.
#

check process puma_<%= @app_name %>
  with pidfile /var/run/engineyard/<%= @app_name %>/puma.pid
  start program = "/data/<%= @app_name %>/shared/config/<%= @app_name %>_puma_control start" as uid deploy and gid deploy
  stop program = "/data/<%= @app_name %>/shared/config/<%= @app_name %>_puma_control stop" as uid deploy and gid deploy
  group puma_<%= @app_name %>

# This script will check not only the master (above) but any worker matching 'puma: cluster worker'
# and if any of those workers have memory > 255 MB, the entire cluster will experience a hot restart
<% @num_workers.times do |n| %>

check process puma_<%= @app_name %>_worker_<%= n %>
  matching "puma: cluster worker"
  if mem > 255.0 MB for 2 cycles then exec "/data/<%= @app_name %>/shared/config/<%= @app_name %>_puma_control restart" as uid deploy and gid deploy

<% end %>
